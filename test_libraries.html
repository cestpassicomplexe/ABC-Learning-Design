<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test des bibliothèques DOCX et ODT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Test des bibliothèques d'export</h1>

    <div id="status"></div>

    <h2>Résultats des tests</h2>
    <div id="results"></div>

    <h2>Actions de test</h2>
    <button onclick="testDOCX()">Tester DOCX</button>
    <p style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">
        <strong>Note:</strong> L'export ODT utilise une approche différente (conversion HTML) et sera testé directement
        dans l'application principale.
    </p>

    <!-- DOCX.js for Word document generation -->
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/build/index.min.js"></script>

    <!-- FileSaver.js for file download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        function addStatus(message, type) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            statusDiv.appendChild(div);
        }

        function addResult(message, type) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        // Vérifier le chargement des bibliothèques au chargement de la page
        window.addEventListener('load', () => {
            addStatus('Page chargée, vérification des bibliothèques...', 'info');

            // Attendre un peu pour que les scripts se chargent
            setTimeout(() => {
                // Test DOCX
                console.log('window.docx:', window.docx);
                console.log('typeof window.docx:', typeof window.docx);

                if (typeof window.docx !== 'undefined' && window.docx) {
                    addStatus('✓ Bibliothèque DOCX chargée avec succès', 'success');
                    console.log('DOCX library:', window.docx);
                    try {
                        console.log('DOCX exports:', Object.keys(window.docx));
                    } catch (e) {
                        console.log('Cannot list DOCX exports:', e);
                    }
                } else {
                    addStatus('✗ Bibliothèque DOCX non chargée', 'error');
                    addStatus('Vérifiez la console pour plus de détails', 'info');
                }
            }, 1000);
        });

        function testDOCX() {
            resultsDiv.innerHTML = '';

            if (typeof window.docx === 'undefined') {
                addResult('❌ Erreur : La bibliothèque DOCX n\'est pas chargée', 'error');
                return;
            }

            try {
                const { Document, Paragraph, TextRun, HeadingLevel } = window.docx;

                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({
                                text: "Test DOCX",
                                heading: HeadingLevel.HEADING_1,
                            }),
                            new Paragraph({
                                children: [
                                    new TextRun({ text: 'Ceci est un test de génération DOCX.', bold: true }),
                                ],
                            }),
                        ],
                    }],
                });

                window.docx.Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'test.docx';
                    a.click();
                    URL.revokeObjectURL(url);

                    addResult('✅ Fichier DOCX généré avec succès !', 'success');
                }).catch(err => {
                    addResult(`❌ Erreur lors de la génération : ${err.message}`, 'error');
                    console.error(err);
                });

            } catch (err) {
                addResult(`❌ Erreur : ${err.message}`, 'error');
                console.error(err);
            }
        }

        function testODT() {
            resultsDiv.innerHTML = '';

            if (typeof window.simpleOdf === 'undefined') {
                addResult('❌ Erreur : La bibliothèque simple-odf n\'est pas chargée', 'error');
                return;
            }

            try {
                const { TextDocument } = window.simpleOdf;
                const document = new TextDocument();

                document.addHeading('Test ODT', 1);
                document.addParagraph('Ceci est un test de génération ODT.');

                document.saveFlat().then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'test.odt';
                    a.click();
                    URL.revokeObjectURL(url);

                    addResult('✅ Fichier ODT généré avec succès !', 'success');
                }).catch(err => {
                    addResult(`❌ Erreur lors de la génération : ${err.message}`, 'error');
                    console.error(err);
                });

            } catch (err) {
                addResult(`❌ Erreur : ${err.message}`, 'error');
                console.error(err);
            }
        }
    </script>
</body>

</html>